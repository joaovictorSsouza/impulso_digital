{% extends 'base.html' %}

{% block page_title %}Employee List{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">All Employees</h6>
        <a href="{% url 'new_employee' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-lg me-1"></i> Add New
        </a>
    </div>
    <div class="card-body">

        <!-- Search Form -->
        <div class="row mb-3">
            <div class="col-md-6">
                <form action="{% url 'Employee' %}" method="get" class="d-flex">
                    <input type="text" name="q" class="form-control me-2" placeholder="Search by name or CPF..."
                        value="{{ search_query }}">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="bi bi-search"></i>
                    </button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">Photo</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Sector</th>
                        <th>Level</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in Employee %}
                    <tr class="align-middle">
                        <td class="text-center">
                            {% if employee.photo %}
                            <img src="{{ employee.photo.url }}" alt="Photo of {{ employee.name }}"
                                class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                            <i class="bi bi-person-circle fs-3 text-secondary"></i>
                            {% endif %}
                        </td>
                        <td>
                            {{ employee.name }}<br>
                            <small class="text-muted">{{ employee.cpf }}</small>
                        </td>
                        <td>{{ employee.email|default:"-" }}</td>
                        <td>{{ employee.phone|default:"-" }}</td>
                        <td>{{ employee.sector }}</td>
                        <td>{{ employee.hierarchical_level|default:"-" }}</td>
                        <td>
                            {% if employee.status == 'Active' %}
                            <span class="badge bg-success">Active</span>
                            {% elif employee.status == 'Inactive' %}
                            <span class="badge bg-danger">Inactive</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ employee.status }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <!-- Edit Button converted to <button> to avoid bootstrap backdrop issues -->
                            <button type="button" class="btn btn-warning btn-sm me-1 edit-btn" title="Edit"
                                data-bs-toggle="modal" data-bs-target="#editEmployeeModal" data-id="{{ employee.id }}"
                                data-name="{{ employee.name }}" data-cpf="{{ employee.cpf }}"
                                data-email="{{ employee.email|default:'' }}"
                                data-phone="{{ employee.phone|default:'' }}" data-age="{{ employee.age }}"
                                data-birth-date="{{ employee.birth_date|date:'Y-m-d' }}"
                                data-hire-date="{{ employee.hire_date|date:'Y-m-d' }}"
                                data-sector="{{ employee.sector.id }}"
                                data-hierarchical-level="{{ employee.hierarchical_level.id|default:'' }}"
                                data-status="{{ employee.status }}" data-salary="{{ employee.salary|stringformat:'f' }}"
                                data-contract-time="{{ employee.contract_time }}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <!-- Delete Button -->
                            <button type="button" class="btn btn-danger btn-sm" title="Delete" data-bs-toggle="modal"
                                data-bs-target="#deleteModal-{{ employee.id }}">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </td>
                    </tr>

                    <!-- Delete Confirmation Modal (Inside loop for unique ID targeting) -->
                    <div class="modal fade" id="deleteModal-{{ employee.id }}" tabindex="-1"
                        aria-labelledby="deleteModalLabel-{{ employee.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteModalLabel-{{ employee.id }}">Confirm Deletion
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete the employee <strong>{{ employee.name }}</strong>?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <form action="{% url 'delete_employee' employee.id %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No employees found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                </li>
                <li class="page-item active" aria-current="page"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Next</a>
                </li>
            </ul>
        </nav>

    </div>

    <!-- Edit Employee Modal (Placed inside block content) -->
    <div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEmployeeModalLabel">Edit Employee</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editEmployeeForm" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <!-- Hidden ID Field -->
                        <input type="hidden" id="edit-id" name="id">

                        <!-- Row 1: Name and CPF -->
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="edit-name" class="form-label">Name</label>
                                <input type="text" name="name" id="edit-name" class="form-control" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-cpf" class="form-label">CPF</label>
                                <input type="text" name="cpf" id="edit-cpf" class="form-control">
                            </div>
                        </div>

                        <!-- Row 2: Email and Phone -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-email" class="form-label">Email</label>
                                <input type="email" name="email" id="edit-email" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-phone" class="form-label">Phone</label>
                                <input type="text" name="phone" id="edit-phone" class="form-control">
                            </div>
                        </div>

                        <!-- Row 3: Birth Date, Age, Status -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit-birth-date" class="form-label">Birth Date</label>
                                <input type="date" name="birth_date" id="edit-birth-date" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-age" class="form-label">Age</label>
                                <input type="number" name="age" id="edit-age" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-status" class="form-label">Status</label>
                                <select name="status" id="edit-status" class="form-select">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>

                        <!-- Row 4: Professional Info -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit-sector" class="form-label">Sector</label>
                                <select name="sector" id="edit-sector" class="form-select">
                                    {% for sector in sectors %}
                                    <option value="{{ sector.id }}">{{ sector.sector }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-hierarchical-level" class="form-label">Hierarchical Level</label>
                                <select name="hierarchical_level" id="edit-hierarchical-level" class="form-select">
                                    <option value="">---------</option>
                                    {% for level in hierarchical_levels %}
                                    <option value="{{ level.id }}">{{ level.hierarchical_level }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-hire-date" class="form-label">Hire Date</label>
                                <input type="date" name="hire_date" id="edit-hire-date" class="form-control">
                            </div>
                        </div>

                        <!-- Row 5: Salary, Contract, Photo -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="edit-salary" class="form-label">Salary</label>
                                <input type="number" name="salary" id="edit-salary" step="0.01" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-contract" class="form-label">Contract Duration</label>
                                <input type="text" name="contract_time" id="edit-contract" class="form-control">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="edit-photo" class="form-label">Photo</label>
                                <input type="file" name="photo" id="edit-photo" class="form-control">
                                <small class="text-muted">Leave blank to keep current photo.</small>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editModal = document.getElementById('editEmployeeModal');
        if (editModal) {
            editModal.addEventListener('show.bs.modal', event => {
                // Button that triggered the modal
                const button = event.relatedTarget;

                // Extract info from data-* attributes
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');
                const cpf = button.getAttribute('data-cpf');
                const email = button.getAttribute('data-email');
                const phone = button.getAttribute('data-phone');
                const age = button.getAttribute('data-age');
                const birthDate = button.getAttribute('data-birth-date');
                const hireDate = button.getAttribute('data-hire-date');
                const sector = button.getAttribute('data-sector');
                const level = button.getAttribute('data-hierarchical-level');
                const status = button.getAttribute('data-status');
                const salary = button.getAttribute('data-salary');
                const contract = button.getAttribute('data-contract-time');

                // Form
                const editForm = document.getElementById('editEmployeeForm');

                // Input fields
                const idInput = document.getElementById('edit-id');
                const nameInput = document.getElementById('edit-name');
                const cpfInput = document.getElementById('edit-cpf');
                const emailInput = document.getElementById('edit-email');
                const phoneInput = document.getElementById('edit-phone');
                const ageInput = document.getElementById('edit-age');
                const birthDateInput = document.getElementById('edit-birth-date');
                const hireDateInput = document.getElementById('edit-hire-date');
                const sectorInput = document.getElementById('edit-sector');
                const levelInput = document.getElementById('edit-hierarchical-level');
                const statusInput = document.getElementById('edit-status');
                const salaryInput = document.getElementById('edit-salary');
                const contractInput = document.getElementById('edit-contract');

                // Populate fields
                if (idInput) idInput.value = id;
                if (nameInput) nameInput.value = name;
                if (cpfInput) cpfInput.value = cpf;
                if (emailInput) emailInput.value = email;
                if (phoneInput) phoneInput.value = phone;
                if (ageInput) ageInput.value = age;

                // Dates need strict YYYY-MM-DD format which we ensure in template logic
                if (birthDateInput) birthDateInput.value = birthDate;
                if (hireDateInput) hireDateInput.value = hireDate;

                if (sectorInput) sectorInput.value = sector;
                if (levelInput) levelInput.value = level;
                if (statusInput) statusInput.value = status;

                // Salary formatting
                if (salaryInput) salaryInput.value = salary ? salary.replace(',', '.') : '';

                if (contractInput) contractInput.value = contract;

                // Update Action
                const baseUrl = "{% url 'edit_employee' 0 %}";
                editForm.action = baseUrl.replace('0', id);
            });
        }

        // CPF Mask Logic
        const cpfInput = document.getElementById('edit-cpf');
        if (cpfInput) {
            cpfInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.slice(0, 11);
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            });
        }
    });
</script>
{% endblock %}